<?php

class Productos extends Controller {

    private $modelo;
    private $modeloCategoria;
    private $modeloProveedor;

    public function __construct() {
        $this->modelo = $this->model('Producto');
        $this->modeloCategoria = $this->model('Categoria');
        $this->modeloProveedor = $this->model('Proveedor');
    }

    /**
     * Método index - Listar productos
     */
    public function index() {
        $data = $this->modelo->all();
        $this->view('productos/index', $data);
    }

    /**
     * Método create - Crear nuevo producto
     */
    public function create() {
        $metodo = $_SERVER['REQUEST_METHOD'];
        $data = [
            'accion' => 'Crear',
            'error' => [],
            'categorias' => $this->modeloCategoria->all(),
            'proveedores' => $this->modeloProveedor->all()
        ];

        if ($metodo == 'POST') {
            $data = $_POST;
            $data['categorias'] = $this->modeloCategoria->all();
            $data['proveedores'] = $this->modeloProveedor->all();

            // Manejar foto del producto
            if (!empty($_FILES['producto_foto']['tmp_name'])) {
                $data['producto_foto'] = file_get_contents($_FILES['producto_foto']['tmp_name']);
            } else {
                unset($data['producto_foto']);
            }

            // Validar datos
            $data['error'] = $this->validarProducto($data);

            if (empty($data['error'])) {
                unset($data['error']);
                unset($data['categorias']);
                unset($data['proveedores']);

                $resultado = $this->modelo->create($data);

                if ($resultado) {
                    refresh('/productos');
                } else {
                    $data['error'][] = 'Error al crear el producto';
                }
            }
        }

        $this->view('productos/create', $data);
    }

    /**
     * Método edit - Editar producto
     */
    public function edit($id) {
        $metodo = $_SERVER['REQUEST_METHOD'];

        if ($metodo == 'POST') {
            $data = $_POST;

            // Manejar foto del producto
            if (!empty($_FILES['producto_foto']['tmp_name'])) {
                $data['producto_foto'] = file_get_contents($_FILES['producto_foto']['tmp_name']);
            } else {
                unset($data['producto_foto']);
            }

            unset($data['id']);

            // Validar datos
            $data['error'] = $this->validarProducto($data, true, $id);

            if (empty($data['error'])) {
                unset($data['error']);

                $resultado = $this->modelo->update($id, $data);

                if ($resultado) {
                    refresh('/productos');
                } else {
                    $data['error'][] = 'No se realizaron cambios';
                }
            }
        }

        if (empty($data['error'])) {
            $data = $this->modelo->find($id);
        }

        $data['accion'] = 'Editar';
        $data['error'] ?? [];
        $data['categorias'] = $this->modeloCategoria->all();
        $data['proveedores'] = $this->modeloProveedor->all();

        $this->view('productos/create', $data);
    }

    /**
     * Método destroy - Eliminar producto
     */
    public function destroy($id) {
        $resultado = $this->modelo->delete($id);

        if ($resultado) {
            refresh('/productos');
        } else {
            $data['error'][] = 'Error al eliminar el producto';
        }
    }

    /**
     * Método validarProducto
     */
    public function validarProducto($data, $edit = false, $id = null) {
        $error = [];

        if (empty($data['producto_codigo'])) {
            $error[] = 'El código del producto está vacío';
        } else {
            // Verificar que el código no esté repetido
            $productoExistente = $this->modelo->buscarPorCodigo($data['producto_codigo']);
            if ($productoExistente && (!$edit || $productoExistente['id'] != $id)) {
                $error[] = 'El código del producto ya existe';
            }
        }

        if (empty($data['producto_nombre'])) {
            $error[] = 'El nombre del producto está vacío';
        }

        if (empty($data['producto_precio_compra']) || $data['producto_precio_compra'] <= 0) {
            $error[] = 'El precio de compra debe ser mayor a 0';
        }

        if (empty($data['producto_precio_venta']) || $data['producto_precio_venta'] <= 0) {
            $error[] = 'El precio de venta debe ser mayor a 0';
        }

        if (isset($data['producto_precio_compra']) && isset($data['producto_precio_venta'])) {
            if ($data['producto_precio_venta'] < $data['producto_precio_compra']) {
                $error[] = 'El precio de venta no puede ser menor al precio de compra';
            }
        }

        if (!isset($data['producto_stock']) || $data['producto_stock'] < 0) {
            $error[] = 'El stock no puede ser negativo';
        }

        if (!isset($data['producto_stock_minimo']) || $data['producto_stock_minimo'] < 0) {
            $error[] = 'El stock mínimo no puede ser negativo';
        }

        return $error;
    }

    /**
     * Método json - Exportar a JSON
     */
    public function json() {
        $data = $this->modelo->all();
        $this->view('/productos/json', $data);
    }

    /**
     * Método imprimir - Generar PDF
     */
    public function imprimir() {
        $data = $this->modelo->all();
        $this->view('/productos/fpdf', $data);
    }

    /**
     * Método buscar - Buscar productos
     */
    public function buscar() {
        if (isset($_GET['termino'])) {
            $termino = $_GET['termino'];
            $data = $this->modelo->buscar($termino);
            header('Content-Type: application/json');
            echo json_encode($data);
        }
    }
}
