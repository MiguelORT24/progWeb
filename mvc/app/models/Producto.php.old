<?php
/**
 * Modelo Producto
 * Gestiona los productos del inventario
 * @author Sistema de Inventarios
 * @fecha 22/11/2025
 */

class Producto {
    private $db;
    private $table = 'productos';

    public function __construct() {
        $this->db = new Base($this->table);
    }

    /**
     * Obtener todos los productos con información de categoría y proveedor
     */
    public function all() {
        $sql = "SELECT 
                    p.id,
                    p.producto_codigo,
                    p.producto_nombre,
                    p.producto_descripcion,
                    p.producto_precio_compra,
                    p.producto_precio_venta,
                    p.producto_stock,
                    p.producto_stock_minimo,
                    p.producto_foto,
                    p.categoria_id,
                    p.proveedor_id,
                    c.categoria_nombre,
                    pr.proveedor_nombre,
                    CASE 
                        WHEN p.producto_stock <= p.producto_stock_minimo THEN 'BAJO'
                        WHEN p.producto_stock <= (p.producto_stock_minimo * 1.5) THEN 'MEDIO'
                        ELSE 'NORMAL'
                    END AS nivel_stock
                FROM productos p
                LEFT JOIN categorias c ON p.categoria_id = c.id
                LEFT JOIN proveedores pr ON p.proveedor_id = pr.id
                ORDER BY p.producto_nombre";
        
        $this->db->query($sql);
        return $this->db->resultSet();
    }

    /**
     * Buscar un producto por ID
     */
    public function find($id) {
        return $this->db->find($id);
    }

    /**
     * Crear un nuevo producto
     */
    public function create($data) {
        return $this->db->create($data);
    }

    /**
     * Actualizar un producto
     */
    public function update($id, $data) {
        return $this->db->where('id', $id)->update($data);
    }

    /**
     * Eliminar un producto
     */
    public function delete($id) {
        return $this->db->where('id', $id)->delete();
    }

    /**
     * Buscar producto por código
     */
    public function buscarPorCodigo($codigo) {
        return $this->db->where('producto_codigo', $codigo)->first();
    }

    /**
     * Obtener productos con stock bajo
     */
    public function stockBajo() {
        $sql = "SELECT 
                    p.id,
                    p.producto_codigo,
                    p.producto_nombre,
                    p.producto_stock,
                    p.producto_stock_minimo,
                    c.categoria_nombre
                FROM productos p
                LEFT JOIN categorias c ON p.categoria_id = c.id
                WHERE p.producto_stock <= p.producto_stock_minimo
                ORDER BY p.producto_stock ASC";
        
        $this->db->query($sql);
        return $this->db->resultSet();
    }

    /**
     * Calcular valor total del inventario
     */
    public function valorInventario() {
        $sql = "SELECT 
                    SUM(producto_stock * producto_precio_compra) AS valor_compra,
                    SUM(producto_stock * producto_precio_venta) AS valor_venta,
                    COUNT(*) AS total_productos,
                    SUM(producto_stock) AS total_unidades
                FROM productos";
        
        $this->db->query($sql);
        return $this->db->single();
    }

    /**
     * Buscar productos por nombre o código
     */
    public function buscar($termino) {
        $sql = "SELECT 
                    p.id,
                    p.producto_codigo,
                    p.producto_nombre,
                    p.producto_precio_venta,
                    p.producto_stock,
                    c.categoria_nombre
                FROM productos p
                LEFT JOIN categorias c ON p.categoria_id = c.id
                WHERE p.producto_nombre LIKE :termino 
                   OR p.producto_codigo LIKE :termino
                ORDER BY p.producto_nombre
                LIMIT 20";
        
        $this->db->query($sql);
        $this->db->bind(':termino', "%$termino%");
        return $this->db->resultSet();
    }

    /**
     * Actualizar stock de un producto
     */
    public function actualizarStock($id, $cantidad, $tipo) {
        $producto = $this->find($id);
        if (!$producto) {
            return false;
        }

        $nuevoStock = $tipo === 'entrada' 
            ? $producto['producto_stock'] + $cantidad 
            : $producto['producto_stock'] - $cantidad;

        if ($nuevoStock < 0) {
            return false; // No permitir stock negativo
        }

        return $this->update($id, ['producto_stock' => $nuevoStock]);
    }

    /**
     * Obtener productos por categoría
     */
    public function porCategoria($categoria_id) {
        $sql = "SELECT * FROM productos WHERE categoria_id = :categoria_id ORDER BY producto_nombre";
        $this->db->query($sql);
        $this->db->bind(':categoria_id', $categoria_id);
        return $this->db->resultSet();
    }

    /**
     * Obtener productos por proveedor
     */
    public function porProveedor($proveedor_id) {
        $sql = "SELECT * FROM productos WHERE proveedor_id = :proveedor_id ORDER BY producto_nombre";
        $this->db->query($sql);
        $this->db->bind(':proveedor_id', $proveedor_id);
        return $this->db->resultSet();
    }
}
